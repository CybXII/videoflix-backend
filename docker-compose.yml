services:
  redis:
    image: redis:latest
    container_name: videoflix_redis
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - proxy

  web:
    build:
      context: .
      dockerfile: backend.Dockerfile
    container_name: videoflix_backend
    env_file: .env
    volumes:
      - .:/app
      - videoflix_media:/media
      - videoflix_static:/static
    depends_on:
      - redis
    networks:
      - proxy
      - vpsdb
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.videoflix.rule=Host(`videoflix.luft-alex.de`)"
      - "traefik.http.routers.videoflix.entrypoints=websecure"
      - "traefik.http.routers.videoflix.tls.certresolver=letsencrypt"
      - "traefik.http.services.videoflix.loadbalancer.server.port=8000"

      # Middleware f√ºr CORS
      - "traefik.http.middlewares.videoflix-cors.headers.accessControlAllowOriginList=https://videoflix.luft-alexander.de"
      - "traefik.http.middlewares.videoflix-cors.headers.accessControlAllowMethods=GET,OPTIONS,PUT,POST,PATCH,DELETE"
      - "traefik.http.middlewares.videoflix-cors.headers.accessControlAllowHeaders=Content-Type,Authorization"
      - "traefik.http.routers.videoflix.middlewares=videoflix-cors"

volumes:
  redis_data:
  videoflix_media:
  videoflix_static:

networks:
  vpsdb:
    external: true
  proxy:
    external: true
