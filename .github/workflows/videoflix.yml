name: Videoflix CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-test-deploy:
    runs-on: ubuntu-latest
    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      DJANGO_SUPERUSER_USERNAME: ${{ secrets.DJANGO_SUPERUSER_USERNAME }}
      DJANGO_SUPERUSER_EMAIL: ${{ secrets.DJANGO_SUPERUSER_EMAIL }}
      DJANGO_SUPERUSER_PASSWORD: ${{ secrets.DJANGO_SUPERUSER_PASSWORD }}

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîê Generate .env file from GitHub Secret
        run: |
          echo "${{ secrets.ENV }}" > .env

      - name: üìÅ Prepare deployment files
        run: |
          mkdir -p deploy
          chmod +x backend.entrypoint.sh

          cp backend.Dockerfile backend.entrypoint.sh docker-compose.yml requirements.txt .env manage.py deploy/
          
          # Nur die relevanten Projekt-Ordner √ºbertragen
          rsync -av --exclude '__pycache__' videoflix/ deploy/videoflix/
          rsync -av --exclude '__pycache__' videoflix_app/ deploy/videoflix_app/

      - name: Ensure target directory exists
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p /home/${{ secrets.USERNAME }}/videoflix-backend

      - name: üì§ Upload to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy"
          target: "/home/cybxii/videoflix-backend"
          strip_components: 1
          debug: true
          overwrite: true

      - name: üê≥ Run Docker Compose on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          envs: POSTGRES_USER,POSTGRES_PASSWORD,DJANGO_SUPERUSER_USERNAME,DJANGO_SUPERUSER_EMAIL,DJANGO_SUPERUSER_PASSWORD
          script: |
            cd /home/cybxii/videoflix-backend

            echo "üöÄ Starte Deployment..."
            docker compose down --remove-orphans || true
            docker compose build
            docker compose up -d
            echo "‚è≥ Warte auf Container-Start..."
            sleep 20

            echo "üîé Pr√ºfe/erstelle Videoflix-Datenbank..."
            docker exec -i postgres-main psql -U $POSTGRES_USER -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='videoflix'" | grep -q 1 \
              || docker exec -i postgres-main psql -U $POSTGRES_USER -d postgres -c "CREATE DATABASE videoflix OWNER $POSTGRES_USER;"

            echo "‚öô Pr√ºfe ob Migrationen existieren..."
            if ! docker exec videoflix_backend sh -c "ls videoflix_app/migrations/[0-9]*.py >/dev/null 2>&1"; then
              echo "üì¶ Keine echten Migrationen gefunden ‚Äì erstelle neue."
              docker exec videoflix_backend python manage.py makemigrations --noinput
            else
              echo "‚úÖ Echte Migrationen vorhanden ‚Äì √ºberspringe makemigrations."
            fi

            echo "‚öô F√ºhre Django Management Commands aus..."
            docker exec videoflix_backend python manage.py migrate --noinput
            docker exec videoflix_backend python manage.py collectstatic --noinput

            echo "üë§ Superuser pr√ºfen/erstellen..."
            if [ -n "$DJANGO_SUPERUSER_USERNAME" ] && [ -n "$DJANGO_SUPERUSER_EMAIL" ] && [ -n "$DJANGO_SUPERUSER_PASSWORD" ]; then
              docker exec videoflix_backend python manage.py shell -c "from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.filter(username='$DJANGO_SUPERUSER_USERNAME').exists() or User.objects.create_superuser('$DJANGO_SUPERUSER_USERNAME', '$DJANGO_SUPERUSER_EMAIL', '$DJANGO_SUPERUSER_PASSWORD')"
            else
              echo "‚ö†Ô∏è Superuser-Variablen nicht gesetzt ‚Äì √ºberspringe."
            fi
